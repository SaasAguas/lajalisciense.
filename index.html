<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>POS | Mi Negocio</title>
    <style>
        /* --- CONFIGURACI√ìN BASE Y VARIABLES CSS --- */
        :root {
            --primary: #2c3e50; /* Azul Oscuro */
            --secondary: #34495e; /* Azul Gris√°ceo */
            --accent: #3498db; /* Azul Brillante */
            --success: #27ae60; /* Verde */
            --danger: #c0392b; /* Rojo */
            --light: #ecf0f1; /* Gris Claro Fondo */
            --white: #ffffff;
            --shadow: 0 4px 6px rgba(0,0,0,0.1);
            --radius: 8px;
            --font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
        }

        * { box-sizing: border-box; margin: 0; padding: 0; }

        body {
            font-family: var(--font-family);
            background-color: var(--light);
            color: var(--primary);
            height: 100vh;
            display: flex;
            flex-direction: column;
            overflow: hidden; /* Evita scroll doble en m√≥viles */
        }

        /* --- UTILIDADES --- */
        .hidden { display: none !important; }
        .btn {
            border: none; padding: 10px 15px; border-radius: var(--radius); cursor: pointer; font-size: 1rem; font-weight: bold; transition: 0.2s;
            display: inline-flex; align-items: center; justify-content: center; gap: 5px;
        }
        .btn:active { transform: scale(0.98); }
        .btn-primary { background-color: var(--primary); color: var(--white); }
        .btn-accent { background-color: var(--accent); color: var(--white); }
        .btn-success { background-color: var(--success); color: var(--white); }
        .btn-danger { background-color: var(--danger); color: var(--white); }
        .btn-block { width: 100%; }
        
        input, select {
            padding: 10px; border: 1px solid #bdc3c7; border-radius: var(--radius); font-size: 1rem; width: 100%; margin-bottom: 10px;
        }

        /* --- LAYOUT PRINCIPAL --- */
        header {
            background-color: var(--primary); color: var(--white); padding: 15px; display: flex; justify-content: space-between; align-items: center;
            box-shadow: var(--shadow); z-index: 10;
        }
        header h1 { font-size: 1.2rem; display: flex; align-items: center; gap: 10px; }

        main {
            flex: 1; overflow-y: auto; padding: 15px; position: relative;
        }

        /* --- BARRA DE NAVEGACI√ìN INFERIOR (Mobile Style) --- */
        nav.bottom-nav {
            background-color: var(--white); border-top: 1px solid #bdc3c7; display: flex; justify-content: space-around; padding: 10px 0;
        }
        nav button {
            background: none; border: none; font-size: 0.8rem; color: var(--secondary); display: flex; flex-direction: column; align-items: center;
        }
        nav button.active { color: var(--accent); font-weight: bold; }
        nav button span.icon { font-size: 1.5rem; margin-bottom: 2px; }

        /* --- LOGIN --- */
        #login-view {
            display: flex; flex-direction: column; justify-content: center; align-items: center; height: 100%; text-align: center;
        }
        .user-card {
            background: var(--white); padding: 20px; border-radius: var(--radius); box-shadow: var(--shadow); width: 300px; margin-bottom: 20px; cursor: pointer; transition: 0.3s; border: 2px solid transparent;
        }
        .user-card:hover { border-color: var(--accent); transform: translateY(-3px); }

        /* --- POS (PUNTO DE VENTA) --- */
        .pos-layout { display: flex; flex-direction: column; height: 100%; gap: 15px; }
        
        .product-grid {
            display: grid; grid-template-columns: repeat(auto-fill, minmax(140px, 1fr)); gap: 10px; overflow-y: auto; flex: 1;
        }
        
        .product-card {
            background: var(--white); padding: 10px; border-radius: var(--radius); box-shadow: var(--shadow); text-align: center; cursor: pointer; display: flex; flex-direction: column; justify-content: space-between; height: 100%; border: 1px solid transparent;
        }
        .product-card:active { background-color: #e8f6f3; border-color: var(--success); }
        .product-price { font-weight: bold; color: var(--success); font-size: 1.1rem; }
        .product-stock { font-size: 0.8rem; color: #7f8c8d; }
        .low-stock { color: var(--danger); font-weight: bold; }

        /* Carrito Flotante / Panel */
        .cart-panel {
            background: var(--white); border-top: 2px solid var(--primary); padding: 15px; border-radius: var(--radius) var(--radius) 0 0; box-shadow: 0 -4px 10px rgba(0,0,0,0.1);
        }
        .cart-item { display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #ecf0f1; padding: 8px 0; }
        .cart-total { font-size: 1.5rem; font-weight: bold; text-align: right; margin: 10px 0; }

        /* --- INVENTARIO & TABLAS --- */
        .table-container { overflow-x: auto; background: var(--white); border-radius: var(--radius); box-shadow: var(--shadow); margin-top: 15px; }
        table { width: 100%; border-collapse: collapse; min-width: 500px; }
        th, td { padding: 12px; text-align: left; border-bottom: 1px solid #ddd; }
        th { background-color: var(--secondary); color: var(--white); }
        tr:hover { background-color: #f1f1f1; }

        /* --- DASHBOARD --- */
        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px; margin-bottom: 20px; }
        .stat-card { background: var(--white); padding: 20px; border-radius: var(--radius); box-shadow: var(--shadow); text-align: center; }
        .stat-value { font-size: 2rem; font-weight: bold; color: var(--primary); }
        .stat-label { color: #7f8c8d; font-size: 0.9rem; }

    </style>
</head>
<body>

    <header id="main-header" class="hidden">
        <h1>üè™ <span id="app-title">Mi Negocio</span></h1>
        <div>
            <span id="user-display" style="font-size: 0.9rem; margin-right: 10px;"></span>
            <button class="btn btn-danger" style="padding: 5px 10px;" onclick="app.logout()">üö™</button>
        </div>
    </header>

    <main id="main-content">
        
        <section id="login-view">
            <h2 style="margin-bottom: 30px;">Selecciona tu Perfil</h2>
            <div class="user-card" onclick="app.login('admin')">
                <div style="font-size: 3rem;">ü§µ‚Äç‚ôÇÔ∏è</div>
                <h3>Administrador</h3>
                <p>Acceso Total</p>
            </div>
            <div class="user-card" onclick="app.login('cajero')">
                <div style="font-size: 3rem;">üë≤</div>
                <h3>Cajero</h3>
                <p>Solo Ventas</p>
            </div>
        </section>

        <section id="pos-view" class="hidden pos-layout">
            <div style="display:flex; gap:10px;">
                <input type="text" id="search-product" placeholder="üîç Buscar producto..." oninput="app.renderProducts(this.value)">
                <select id="filter-category" onchange="app.renderProducts()" style="width: auto;">
                    <option value="">Todas</option>
                    <option value="Ropa">Ropa</option>
                    <option value="Electr√≥nica">Electr√≥nica</option>
                    <option value="Hogar">Hogar</option>
                </select>
            </div>

            <div id="products-container" class="product-grid">
                </div>

            <div class="cart-panel">
                <div id="cart-items" style="max-height: 150px; overflow-y: auto;">
                    <p style="text-align:center; color:#999;">Carrito vac√≠o</p>
                </div>
                <div class="cart-total">Total: $<span id="cart-total">0.00</span></div>
                <button class="btn btn-success btn-block" onclick="app.checkout()">üí∞ COBRAR</button>
            </div>
        </section>

        <section id="inventory-view" class="hidden">
            <h2>üì¶ Gesti√≥n de Inventario</h2>
            <br>
            
            <div style="background:var(--white); padding:15px; border-radius:var(--radius); box-shadow:var(--shadow);">
                <h4>Agregar Nuevo Producto</h4>
                <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px; margin-top:10px;">
                    <input type="text" id="new-name" placeholder="Nombre Producto">
                    <input type="number" id="new-price" placeholder="Precio ($)">
                    <input type="text" id="new-cat" placeholder="Categor√≠a">
                    <input type="number" id="new-stock" placeholder="Stock Inicial">
                </div>
                <button class="btn btn-accent btn-block" onclick="app.addProduct()">‚ûï Agregar Producto</button>
            </div>

            <div class="table-container">
                <table>
                    <thead>
                        <tr>
                            <th>Producto</th>
                            <th>Precio</th>
                            <th>Stock</th>
                            <th>Acciones</th>
                        </tr>
                    </thead>
                    <tbody id="inventory-table-body">
                        </tbody>
                </table>
            </div>
        </section>

        <section id="admin-view" class="hidden">
            <h2>üìä Panel de Administraci√≥n</h2>
            <br>

            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-value">$<span id="daily-sales">0</span></div>
                    <div class="stat-label">Ventas Hoy</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value"><span id="items-sold">0</span></div>
                    <div class="stat-label">Productos Vendidos</div>
                </div>
            </div>

            <h3>Acciones</h3>
            <div style="display:grid; gap:10px; margin-top:10px;">
                <button class="btn btn-primary" onclick="app.exportCSV()">üì• Exportar Reporte CSV</button>
                <button class="btn btn-accent" onclick="app.closeRegister()">üîí Cerrar Caja (Reset D√≠a)</button>
                <button class="btn btn-danger" onclick="app.factoryReset()">‚ö†Ô∏è Resetear Base de Datos</button>
            </div>

            <h3 style="margin-top:20px;">√öltimas Transacciones</h3>
            <div class="table-container">
                <table>
                    <thead>
                        <tr>
                            <th>Hora</th>
                            <th>Total</th>
                            <th>Detalle</th>
                        </tr>
                    </thead>
                    <tbody id="sales-history-body"></tbody>
                </table>
            </div>
        </section>

    </main>

    <nav id="bottom-nav" class="bottom-nav hidden">
        <button onclick="app.nav('pos-view')" id="btn-nav-pos" class="active">
            <span class="icon">üõí</span>
            <span>Ventas</span>
        </button>
        <button onclick="app.nav('inventory-view')" id="btn-nav-inv">
            <span class="icon">üì¶</span>
            <span>Inventario</span>
        </button>
        <button onclick="app.nav('admin-view')" id="btn-nav-admin">
            <span class="icon">üìä</span>
            <span>Admin</span>
        </button>
    </nav>

    <script>
        /**
         * L√ìGICA DEL SISTEMA POS
         * Estructura basada en objetos y localStorage
         */
        const app = {
            data: {
                products: [],
                cart: [],
                sales: [],
                currentUser: null
            },

            // --- INICIALIZACI√ìN ---
            init: function() {
                this.loadData();
                this.renderProducts();
            },

            // Cargar datos de localStorage o crear datos de prueba
            loadData: function() {
                const storedProducts = localStorage.getItem('pos_products');
                const storedSales = localStorage.getItem('pos_sales');

                if (storedProducts) {
                    this.data.products = JSON.parse(storedProducts);
                } else {
                    // Datos de prueba iniciales
                    this.data.products = [
                        { id: 1, name: "Camiseta B√°sica", price: 150.00, stock: 20, category: "Ropa" },
                        { id: 2, name: "Jeans Slim", price: 450.00, stock: 10, category: "Ropa" },
                        { id: 3, name: "Aud√≠fonos BT", price: 300.00, stock: 5, category: "Electr√≥nica" },
                        { id: 4, name: "Cargador USB-C", price: 120.00, stock: 15, category: "Electr√≥nica" },
                        { id: 5, name: "Taza Cer√°mica", price: 80.00, stock: 30, category: "Hogar" }
                    ];
                    this.saveData();
                }

                if (storedSales) {
                    this.data.sales = JSON.parse(storedSales);
                }
            },

            saveData: function() {
                localStorage.setItem('pos_products', JSON.stringify(this.data.products));
                localStorage.setItem('pos_sales', JSON.stringify(this.data.sales));
            },

            // --- SISTEMA DE ACCESO ---
            login: function(role) {
                this.data.currentUser = role;
                document.getElementById('login-view').classList.add('hidden');
                document.getElementById('main-header').classList.remove('hidden');
                document.getElementById('bottom-nav').classList.remove('hidden');
                document.getElementById('user-display').textContent = role === 'admin' ? 'Admin' : 'Cajero';

                // Restricciones de UI seg√∫n rol
                if (role === 'cajero') {
                    document.getElementById('btn-nav-inv').classList.add('hidden');
                    document.getElementById('btn-nav-admin').classList.add('hidden');
                } else {
                    document.getElementById('btn-nav-inv').classList.remove('hidden');
                    document.getElementById('btn-nav-admin').classList.remove('hidden');
                }

                this.nav('pos-view');
            },

            logout: function() {
                this.data.currentUser = null;
                this.data.cart = [];
                location.reload(); // Recarga simple para limpiar estado UI
            },

            // --- NAVEGACI√ìN ---
            nav: function(viewId) {
                // Ocultar todas las vistas
                ['pos-view', 'inventory-view', 'admin-view'].forEach(id => {
                    document.getElementById(id).classList.add('hidden');
                });
                // Quitar clase active de botones nav
                document.querySelectorAll('nav button').forEach(btn => btn.classList.remove('active'));

                // Mostrar vista seleccionada
                document.getElementById(viewId).classList.remove('hidden');
                
                // Actualizar bot√≥n activo
                if(viewId === 'pos-view') document.getElementById('btn-nav-pos').classList.add('active');
                if(viewId === 'inventory-view') document.getElementById('btn-nav-inv').classList.add('active');
                if(viewId === 'admin-view') document.getElementById('btn-nav-admin').classList.add('active');

                // Renderizar contenido espec√≠fico si es necesario
                if (viewId === 'inventory-view') this.renderInventory();
                if (viewId === 'admin-view') this.renderAdmin();
            },

            // --- M√ìDULO POS ---
            renderProducts: function(query = '') {
                const container = document.getElementById('products-container');
                const categoryFilter = document.getElementById('filter-category').value;
                container.innerHTML = '';

                const filtered = this.data.products.filter(p => {
                    const matchText = p.name.toLowerCase().includes(query.toLowerCase());
                    const matchCat = categoryFilter === '' || p.category === categoryFilter;
                    return matchText && matchCat;
                });

                filtered.forEach(p => {
                    const card = document.createElement('div');
                    card.className = 'product-card';
                    card.onclick = () => this.addToCart(p.id);
                    card.innerHTML = `
                        <div>
                            <div style="font-size:2rem; margin-bottom:5px;">üì¶</div>
                            <b>${p.name}</b>
                            <div class="product-stock ${p.stock < 5 ? 'low-stock' : ''}">Stock: ${p.stock}</div>
                        </div>
                        <div class="product-price">$${p.price.toFixed(2)}</div>
                    `;
                    container.appendChild(card);
                });
            },

            addToCart: function(id) {
                const product = this.data.products.find(p => p.id === id);
                
                if (product.stock <= 0) {
                    alert('‚ùå Producto agotado');
                    return;
                }

                const itemInCart = this.data.cart.find(i => i.id === id);
                
                // Verificar si agregando uno m√°s superamos el stock real
                const currentQtyInCart = itemInCart ? itemInCart.qty : 0;
                if (currentQtyInCart + 1 > product.stock) {
                    alert('‚ö†Ô∏è No hay suficiente stock disponible');
                    return;
                }

                if (itemInCart) {
                    itemInCart.qty++;
                } else {
                    this.data.cart.push({ ...product, qty: 1 });
                }
                this.renderCart();
            },

            removeFromCart: function(id) {
                this.data.cart = this.data.cart.filter(i => i.id !== id);
                this.renderCart();
            },

            renderCart: function() {
                const container = document.getElementById('cart-items');
                const totalEl = document.getElementById('cart-total');
                container.innerHTML = '';
                
                let total = 0;

                if (this.data.cart.length === 0) {
                    container.innerHTML = '<p style="text-align:center; color:#999; padding:10px;">Carrito vac√≠o</p>';
                } else {
                    this.data.cart.forEach(item => {
                        total += item.price * item.qty;
                        const div = document.createElement('div');
                        div.className = 'cart-item';
                        div.innerHTML = `
                            <span><b>${item.qty}x</b> ${item.name}</span>
                            <div style="display:flex; align-items:center; gap:10px;">
                                <span>$${(item.price * item.qty).toFixed(2)}</span>
                                <button class="btn btn-danger" style="padding:2px 8px; font-size:0.8rem;" onclick="event.stopPropagation(); app.removeFromCart(${item.id})">√ó</button>
                            </div>
                        `;
                        container.appendChild(div);
                    });
                }
                totalEl.textContent = total.toFixed(2);
            },

            checkout: function() {
                if (this.data.cart.length === 0) {
                    alert('‚ö†Ô∏è El carrito est√° vac√≠o');
                    return;
                }

                if (!confirm(`¬øConfirmar cobro por $${document.getElementById('cart-total').textContent}?`)) return;

                // Procesar venta
                const sale = {
                    id: Date.now(),
                    date: new Date().toLocaleString(),
                    total: this.data.cart.reduce((sum, i) => sum + (i.price * i.qty), 0),
                    items: [...this.data.cart], // Copia
                    cashier: this.data.currentUser
                };

                // Actualizar stock
                this.data.cart.forEach(cartItem => {
                    const product = this.data.products.find(p => p.id === cartItem.id);
                    if (product) {
                        product.stock -= cartItem.qty;
                    }
                });

                // Guardar
                this.data.sales.push(sale);
                this.saveData();

                // Limpiar
                this.data.cart = [];
                this.renderCart();
                this.renderProducts(); // Actualizar stock visual
                alert('‚úÖ ¬°Venta realizada con √©xito!');
            },

            // --- M√ìDULO INVENTARIO ---
            renderInventory: function() {
                const tbody = document.getElementById('inventory-table-body');
                tbody.innerHTML = '';
                
                this.data.products.forEach(p => {
                    const tr = document.createElement('tr');
                    tr.innerHTML = `
                        <td>${p.name}<br><small style="color:#7f8c8d">${p.category}</small></td>
                        <td>$${p.price.toFixed(2)}</td>
                        <td>
                            <input type="number" value="${p.stock}" min="0" style="width:60px; margin:0;" 
                                onchange="app.updateStock(${p.id}, this.value)">
                        </td>
                        <td>
                            <button class="btn btn-danger" style="padding:5px 10px;" onclick="app.deleteProduct(${p.id})">üóëÔ∏è</button>
                        </td>
                    `;
                    tbody.appendChild(tr);
                });
            },

            addProduct: function() {
                const name = document.getElementById('new-name').value;
                const price = parseFloat(document.getElementById('new-price').value);
                const category = document.getElementById('new-cat').value;
                const stock = parseInt(document.getElementById('new-stock').value);

                if (!name || isNaN(price) || !category || isNaN(stock)) {
                    alert('‚ö†Ô∏è Por favor completa todos los campos correctamente');
                    return;
                }

                const newProduct = {
                    id: Date.now(),
                    name, price, category, stock
                };

                this.data.products.push(newProduct);
                this.saveData();
                this.renderInventory();
                
                // Limpiar campos
                document.getElementById('new-name').value = '';
                document.getElementById('new-price').value = '';
                document.getElementById('new-cat').value = '';
                document.getElementById('new-stock').value = '';
                alert('‚úÖ Producto agregado');
            },

            updateStock: function(id, newStock) {
                const product = this.data.products.find(p => p.id === id);
                if (product) {
                    product.stock = parseInt(newStock);
                    this.saveData();
                }
            },

            deleteProduct: function(id) {
                if(confirm('¬øSeguro que deseas eliminar este producto?')) {
                    this.data.products = this.data.products.filter(p => p.id !== id);
                    this.saveData();
                    this.renderInventory();
                }
            },

            // --- M√ìDULO ADMIN ---
            renderAdmin: function() {
                // M√©tricas Hoy
                const today = new Date().toLocaleDateString();
                const salesToday = this.data.sales.filter(s => new Date(s.id).toLocaleDateString() === today);
                
                const totalMoney = salesToday.reduce((sum, s) => sum + s.total, 0);
                const itemsCount = salesToday.reduce((sum, s) => sum + s.items.reduce((is, i) => is + i.qty, 0), 0);

                document.getElementById('daily-sales').textContent = totalMoney.toFixed(2);
                document.getElementById('items-sold').textContent = itemsCount;

                // Historial
                const historyBody = document.getElementById('sales-history-body');
                historyBody.innerHTML = '';
                // Mostrar √∫ltimas 10 ventas
                this.data.sales.slice().reverse().slice(0, 10).forEach(s => {
                    const tr = document.createElement('tr');
                    tr.innerHTML = `
                        <td>${new Date(s.id).toLocaleTimeString()}</td>
                        <td>$${s.total.toFixed(2)}</td>
                        <td><small>${s.items.length} productos</small></td>
                    `;
                    historyBody.appendChild(tr);
                });
            },

            exportCSV: function() {
                if (this.data.sales.length === 0) {
                    alert('No hay ventas para exportar');
                    return;
                }
                
                let csvContent = "data:text/csv;charset=utf-8,";
                csvContent += "Fecha,Hora,Vendedor,Total,Productos\n";

                this.data.sales.forEach(row => {
                    const date = new Date(row.id).toLocaleDateString();
                    const time = new Date(row.id).toLocaleTimeString();
                    const itemsSummary = row.items.map(i => `${i.qty}x ${i.name}`).join(' | ');
                    csvContent += `${date},${time},${row.cashier},${row.total},"${itemsSummary}"\n`;
                });

                const encodedUri = encodeURI(csvContent);
                const link = document.createElement("a");
                link.setAttribute("href", encodedUri);
                link.setAttribute("download", "ventas_reporte.csv");
                document.body.appendChild(link);
                link.click();
            },

            closeRegister: function() {
                if(confirm('¬øEst√°s seguro de cerrar caja? Esto pondr√° el contador de hoy a cero visualmente, pero el historial se mantiene.')) {
                   alert('Caja cerrada. Total recaudado hoy: $' + document.getElementById('daily-sales').textContent);
                   location.reload(); 
                }
            },

            factoryReset: function() {
                const secret = prompt("Escribe 'BORRAR' para confirmar el reseteo total de f√°brica:");
                if (secret === 'BORRAR') {
                    localStorage.clear();
                    location.reload();
                }
            }
        };

        // Iniciar App
        app.init();
    </script>
</body>
</html>

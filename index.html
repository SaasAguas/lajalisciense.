<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>La Jalisciense Pro</title>

    <link rel="icon" type="image/png" href="logo.png">
    <link rel="shortcut icon" type="image/png" href="logo.png">
    <link rel="apple-touch-icon" href="logo.png">
    
    <meta name="theme-color" content="#6A1B9A">
    <style>
        /* --- TEMA LAVANDA (COINCIDE CON TU LOGO) --- */
        :root {
            --primary: #6A1B9A; 
            --primary-light: #AB47BC;
            --accent: #00E676;
            --bg: #F3E5F5;
            --text: #2c2c2c;
            --card-bg: #FFFFFF;
            --danger: #FF5252;
        }

        body { 
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; 
            margin: 0; background-color: var(--bg); color: var(--text); padding-bottom: 90px; 
        }
        
        /* NAVEGACI√ìN */
        nav { 
            position: fixed; bottom: 0; width: 100%; 
            background: var(--card-bg); display: flex; justify-content: space-around; 
            padding: 10px 0; border-top: 1px solid #eee; z-index: 1000; 
            box-shadow: 0 -2px 10px rgba(0,0,0,0.05); 
        }
        .nav-btn { 
            background: none; border: none; font-size: 0.8rem; 
            display: flex; flex-direction: column; align-items: center; 
            color: #999; width: 33%; 
            display: flex; 
        }
        .nav-btn.hidden-role { display: none !important; }
        .nav-btn.active { color: var(--primary); font-weight: bold; }
        .nav-icon { font-size: 1.5rem; margin-bottom: 2px; }

        /* PANTALLAS */
        .screen { display: none; padding: 15px; animation: fadeIn 0.3s; }
        .active-screen { display: block; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

        /* CARDS & GENERAL */
        .card { 
            background: var(--card-bg); padding: 15px; border-radius: 15px; 
            box-shadow: 0 4px 6px rgba(106, 27, 154, 0.05); margin-bottom: 15px; 
        }
        h2 { margin-top: 0; color: var(--primary); font-size: 1.3rem; }
        
        /* BOTONES */
        .btn { width: 100%; padding: 12px; border: none; border-radius: 10px; font-weight: bold; font-size: 1rem; color: white; margin-top: 10px; cursor: pointer; }
        .btn-primary { background: var(--primary); }
        .btn-success { background: var(--accent); color: #004d25; }
        .btn-danger { background: var(--danger); }
        .btn-sm { background: #E1BEE7; color: var(--primary); border: none; padding: 6px 14px; border-radius: 20px; font-weight: bold; font-size: 0.85rem; cursor: pointer; }

        /* FILTROS */
        .filter-container { display: flex; gap: 8px; margin-bottom: 15px; }
        .filter-btn { flex: 1; padding: 10px 2px; border: none; border-radius: 12px; background-color: #E1BEE7; color: #4A148C; font-weight: bold; font-size: 0.85rem; cursor: pointer; transition: all 0.2s; }
        .filter-btn.active { background-color: var(--primary); color: white; transform: scale(1.05); box-shadow: 0 3px 6px rgba(106, 27, 154, 0.3); }

        /* GRID */
        .grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px; }
        .flavor-card { background: white; padding: 15px 10px; border-radius: 12px; text-align: center; border: 1px solid #eee; position: relative; }
        .flavor-card:active { background-color: #E1BEE7; border-color: var(--primary); transform: scale(0.98); }
        .stock-badge { font-size: 0.85rem; background: #f3e5f5; color: var(--primary); padding: 2px 8px; border-radius: 8px; display: inline-block; margin-top: 5px; font-weight: bold; }
        
        /* CARRO & VARIOS */
        .cart-bar { position: fixed; bottom: 75px; left: 15px; right: 15px; background: var(--primary); color: white; padding: 15px; border-radius: 50px; display: none; justify-content: space-between; align-items: center; box-shadow: 0 4px 15px rgba(106, 27, 154, 0.4); z-index: 900; animation: slideUp 0.3s; }
        @keyframes slideUp { from { transform: translateY(20px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        .qty-selector { display: flex; align-items: center; justify-content: space-between; margin: 15px 0; background: #f3e5f5; border-radius: 10px; padding: 5px; }
        .qty-btn { width: 45px; height: 45px; border: none; background: white; border-radius: 8px; font-size: 1.2rem; font-weight: bold; color: var(--primary); }
        .stats-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 15px; }
        .stat-item { background: rgba(255,255,255,0.15); padding: 10px; border-radius: 10px; font-size: 0.85rem; }
        .stat-val { display: block; font-size: 1.2rem; font-weight: bold; margin-top: 5px; }
        table { width: 100%; border-collapse: collapse; font-size: 0.9rem; }
        th, td { text-align: left; padding: 10px; border-bottom: 1px solid #f3e5f5; }
        .cart-list-item { display: flex; justify-content: space-between; align-items: center; padding: 10px 0; border-bottom: 1px solid #eee; }
        .delete-btn { background: var(--danger); color: white; border: none; border-radius: 8px; width: 35px; height: 35px; font-weight: bold; font-size: 1.2rem; margin-left: 10px; }

        /* LOGIN STYLES */
        #login-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: var(--primary); z-index: 5000;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
        }
        .login-box {
            background: white; padding: 30px; border-radius: 20px; width: 80%; max-width: 350px;
            text-align: center; box-shadow: 0 10px 30px rgba(0,0,0,0.3);
        }
        .login-input {
            width: 100%; padding: 12px; margin: 10px 0; 
            border: 2px solid #E1BEE7; border-radius: 10px; box-sizing: border-box; font-size: 1rem;
        }
        .logout-btn {
            background: rgba(255,255,255,0.2); color: white; padding: 5px 15px;
            border-radius: 15px; border:none; font-size: 0.8rem; cursor: pointer;
        }
        
        /* ANIMACI√ìN DEL LOGO */
        .logo-anim { animation: pulse 2s infinite; }
        @keyframes pulse { 0% { transform: scale(1); } 50% { transform: scale(1.05); } 100% { transform: scale(1); } }
    </style>
</head>
<body>

    <div id="login-overlay">
        <div class="login-box">
            <img src="logo.png" alt="Logo" style="width: 120px; margin-bottom: 10px;" class="logo-anim">
            <h2 style="color:var(--primary); margin:0 0 10px 0;">Bienvenido</h2>
            <p style="color:#666; margin-top:0;">Sistema de Gesti√≥n</p>
            
            <input type="text" id="login-user" class="login-input" placeholder="Usuario">
            <input type="password" id="login-pass" class="login-input" placeholder="Contrase√±a">
            
            <button class="btn btn-primary" onclick="attemptLogin()">Entrar</button>
            <p id="login-error" style="color:red; display:none; margin-top:10px;">Datos incorrectos</p>
        </div>
        <p style="color:rgba(255,255,255,0.7); margin-top:20px; font-size:0.8rem;">La Jalisciense App v2.1</p>
    </div>

    <div style="background: var(--primary); color: white; padding: 10px 15px; position: sticky; top:0; z-index: 900; display:flex; justify-content:space-between; align-items:center; box-shadow: 0 2px 10px rgba(0,0,0,0.1);">
        <div style="display:flex; align-items:center; gap:10px;">
            <img src="logo.png" style="width:30px; height:30px; border-radius:50%; background:white; padding:2px;">
            <span style="font-weight:bold; font-size:0.9rem;" id="user-display">Invitado</span>
        </div>
        <button class="logout-btn" onclick="doLogout()">Salir</button>
    </div>

    <div id="screen-pos" class="screen">
        <div class="card">
            <div class="filter-container">
                <button class="filter-btn active" onclick="setFilter('fruta', this)">Fruta üçì</button>
                <button class="filter-btn" onclick="setFilter('crema', this)">Crema ü•õ</button>
                <button class="filter-btn" onclick="setFilter('paleta', this)">Paletas üç®</button>
            </div>
            
            <div id="price-container" style="background:#f9f9f9; padding:10px; border-radius:10px; margin-bottom:15px;">
                <label style="font-size:0.9rem; color:#666; font-weight:bold;">Precio por Litro:</label>
                <select id="price-select" style="width:100%; padding:10px; margin-top:5px; border:1px solid #ddd; border-radius:8px; font-weight:bold; color:var(--primary);">
                    <option value="20" selected>$20 (Est√°ndar)</option>
                    <option value="16">$16 (Mayoreo)</option>
                    <option value="15">$15 (Especial)</option>
                </select>
            </div>
            
            <div id="fixed-price-msg" style="display:none; background:#E1BEE7; color:#4A148C; padding:10px; border-radius:10px; margin-bottom:15px; text-align:center; font-weight:bold;">
                Precios Fijos seg√∫n producto
            </div>

            <div class="grid" id="flavors-grid"></div>
        </div>
    </div>

    <div id="cart-bar" class="cart-bar" onclick="showCheckout()">
        <span id="cart-count" style="background:white; color:var(--primary); padding:2px 8px; border-radius:10px; font-weight:bold;">0</span>
        <strong id="cart-total" style="font-size:1.1rem;">$0</strong>
        <span style="font-weight:bold;">Ver Carrito üõí</span>
    </div>

    <div id="screen-prod" class="screen">
        <div class="card">
            <h2 style="margin-bottom: 15px;">üè≠ Producci√≥n</h2>
            <div class="filter-container">
                <button id="btn-prod-fruta" class="filter-btn active" onclick="setProdMode('fruta')">Fruta üçì</button>
                <button id="btn-prod-crema" class="filter-btn" onclick="setProdMode('crema')">Crema ü•õ</button>
                <button id="btn-prod-paleta" class="filter-btn" onclick="setProdMode('paleta')">Paletas üç≠</button>
            </div>

            <p style="font-size:0.9rem; color:#666; text-align:center;" id="prod-subtitle">Registrar producci√≥n de Fruta</p>
            
            <label style="font-weight:bold; color:var(--primary);">Producto:</label>
            <select id="prod-flavor" style="width:100%; padding:12px; margin:10px 0; border:1px solid #ddd; border-radius:10px; background:white;"></select>
            
            <label style="font-weight:bold; color:var(--primary);">Cantidad:</label>
            <div class="qty-selector">
                <button class="qty-btn" onclick="adjustProd(-5)">-5</button>
                <input type="number" id="prod-qty" value="20" style="border:none; background:transparent; text-align:center; font-size:1.5rem; width:60px; font-weight:bold;">
                <button class="qty-btn" onclick="adjustProd(5)">+5</button>
            </div>

            <button class="btn btn-primary" onclick="saveProduction()">Guardar Producci√≥n</button>
        </div>
    </div>

    <div id="screen-admin" class="screen">
        <div class="card" style="text-align:center; background: linear-gradient(135deg, var(--primary), #8E24AA); color: white;">
            <h2 style="color:white; border-bottom-color: rgba(255,255,255,0.2);">Caja Actual</h2>
            <h1 id="stat-cash" style="font-size:3rem; margin:10px 0;">$0</h1>
            
            <div class="stats-grid">
                <div class="stat-item">
                    <span>Ventas (Aguas)</span>
                    <span class="stat-val" id="stat-sold-l">0 L</span>
                </div>
                <div class="stat-item">
                    <span>Ventas (Paletas)</span>
                    <span class="stat-val" id="stat-sold-p">0 Pz</span>
                </div>
                <div class="stat-item">
                    <span>Fab. (Aguas)</span>
                    <span class="stat-val" id="stat-prod-l">0 L</span>
                </div>
                <div class="stat-item">
                    <span>Relleno (Palet)</span>
                    <span class="stat-val" id="stat-prod-p">0 Pz</span>
                </div>
            </div>

            <button class="btn" style="background:rgba(255,255,255,0.2); color:white; margin-top:15px;" onclick="closeDay()">üîí Corte de Caja</button>
        </div>

        <div class="card">
            <div style="display:flex; justify-content:space-between; align-items:center; border-bottom:2px solid #f3e5f5; padding-bottom:10px; margin-bottom:10px;">
                <h2 style="margin:0; border:none; font-size:1.1rem;" id="inv-title">Inventario</h2>
                <button class="btn-sm" onclick="toggleInvView()">üîÑ Cambiar</button>
            </div>
            <div style="max-height:300px; overflow-y:auto;">
                <table id="inv-table"><tbody></tbody></table>
            </div>
        </div>

        <div class="card">
            <h2>üìù Historial</h2>
            <div style="display:flex; gap:10px;">
                <button onclick="downloadExcel()" class="btn btn-success" style="margin-top:0;">‚¨á Excel</button>
                <button onclick="clearHistory()" class="btn btn-danger" style="margin-top:0; background:#D32F2F;">üóë Borrar</button>
            </div>
            
            <div style="max-height:250px; overflow-y:auto; margin-top:15px;">
                <table id="hist-table"><tbody></tbody></table>
            </div>
        </div>
    </div>

    <div id="checkout-modal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.6); z-index:2000; align-items:center; justify-content:center;">
        <div style="background:white; width:90%; max-width:400px; padding:25px; border-radius:15px; box-shadow:0 10px 25px rgba(0,0,0,0.2);">
            <h3 style="margin-top:0; color:var(--primary);">üõí Confirmar Venta</h3>
            <div id="checkout-list" style="max-height: 250px; overflow-y: auto; margin-bottom:20px;"></div>
            <div style="text-align:right; font-size:1.5rem; font-weight:bold; margin-bottom:20px; border-top:1px solid #eee; padding-top:10px;" id="checkout-total">Total: $0</div>
            <div style="display:flex; gap:10px;">
                <button class="btn btn-danger" style="margin:0;" onclick="document.getElementById('checkout-modal').style.display='none'">Cerrar</button>
                <button class="btn btn-success" style="margin:0;" onclick="finishSale()">Cobrar</button>
            </div>
        </div>
    </div>

    <nav>
        <button id="nav-pos" class="nav-btn" onclick="go('pos', this)">
            <span class="nav-icon">üè™</span>Venta
        </button>
        <button id="nav-prod" class="nav-btn" onclick="go('prod', this)">
            <span class="nav-icon">üè≠</span>Prod.
        </button>
        <button id="nav-admin" class="nav-btn" onclick="go('admin', this)">
            <span class="nav-icon">üìä</span>Admin
        </button>
    </nav>

    <script>
        // --- CONFIGURACI√ìN DE USUARIOS ---
        const USERS = {
            'admin':   { pass: 'admin123', role: 'admin' },   
            'ventas':  { pass: 'caja1',    role: 'ventas' },  
            'fabrica': { pass: 'prod1',    role: 'fabrica' }  
        };

        let CURRENT_USER = null;

        function attemptLogin() {
            const u = document.getElementById('login-user').value.toLowerCase();
            const p = document.getElementById('login-pass').value;
            const err = document.getElementById('login-error');

            if (USERS[u] && USERS[u].pass === p) {
                CURRENT_USER = USERS[u];
                // Mostramos nombre en may√∫scula
                document.getElementById('user-display').innerText = u.toUpperCase();
                document.getElementById('login-overlay').style.display = 'none';
                applyRolePermissions(CURRENT_USER.role);
                
                document.getElementById('login-user').value = '';
                document.getElementById('login-pass').value = '';
                err.style.display = 'none';
            } else {
                err.style.display = 'block';
            }
        }

        function doLogout() {
            CURRENT_USER = null;
            document.getElementById('login-overlay').style.display = 'flex';
            document.querySelectorAll('.screen').forEach(s => s.classList.remove('active-screen'));
        }

        function applyRolePermissions(role) {
            const bPos = document.getElementById('nav-pos');
            const bProd = document.getElementById('nav-prod');
            const bAdmin = document.getElementById('nav-admin');

            [bPos, bProd, bAdmin].forEach(b => b.classList.remove('hidden-role'));

            if (role === 'ventas') {
                bProd.classList.add('hidden-role');
                bAdmin.classList.add('hidden-role');
                go('pos', bPos);
            } else if (role === 'fabrica') {
                bPos.classList.add('hidden-role');
                bAdmin.classList.add('hidden-role');
                go('prod', bProd);
            } else {
                go('admin', bAdmin);
            }
        }

        // --- BASE DE DATOS ---
        const DB_KEY = 'jalisciense_final_v8.1';
        
        const realFlavors = [
            {n:'Jamaica', t:'fruta', s:20}, {n:'Maracuya', t:'fruta', s:20}, {n:'Ciruela', t:'fruta', s:20},
            {n:'Lima', t:'fruta', s:20}, {n:'Fresa-Hierbabuena', t:'fruta', s:20}, {n:'Fresa', t:'fruta', s:20},
            {n:'Guayaba-Hierbabuena', t:'fruta', s:20}, {n:'Guayaba-Fresa', t:'fruta', s:20}, {n:'Pi√±a-Alfalfa', t:'fruta', s:20},
            {n:'Guayaba', t:'fruta', s:20}, {n:'Lima-Albahaca', t:'fruta', s:20}, {n:'Mel√≥n', t:'fruta', s:20},
            {n:'Hierbabuena-Lim√≥n', t:'fruta', s:20}, {n:'Mango', t:'fruta', s:20}, {n:'Lim√≥n-Alfalfa', t:'fruta', s:20},
            {n:'Pi√±a-Naranja', t:'fruta', s:20}, {n:'Lim√≥n-Hierbabuena', t:'fruta', s:20}, {n:'Pi√±a-Hierbabuena', t:'fruta', s:20},
            {n:'Lim√≥n-Chia', t:'fruta', s:20}, {n:'Lim√≥n Pepino', t:'fruta', s:20}, {n:'Pi√±a Naranja H.', t:'fruta', s:20},
            {n:'Mel√≥n C√≠trico', t:'fruta', s:20}, {n:'Lima-Stevia', t:'fruta', s:20},
            {n:'Horchata Fresa', t:'crema', s:15}, {n:'Horchata Arroz', t:'crema', s:15}, {n:'Vainilla', t:'crema', s:15},
            {n:'Mazap√°n', t:'crema', s:15}, {n:'Chai', t:'crema', s:15}, {n:'Taro', t:'crema', s:15},
            {n:'Coco c/ Nuez', t:'crema', s:15}, {n:'Cebada', t:'crema', s:15}, {n:'Kalhua', t:'crema', s:15},
            {n:'Crema Irlandesa', t:'crema', s:15},
            {n:'Paleta-Leche', t:'paleta', s:20, p:30}, {n:'Paleta-Agua', t:'paleta', s:20, p:25},
            {n:'Fresas Con Crema', t:'paleta', s:20, p:25}, {n:'Sandwich', t:'paleta', s:20, p:20},
            {n:'Campana', t:'paleta', s:20, p:20},
            {n:'Frapuchino', t:'paleta', s:999, p:10, hidden: true}
        ];

        let db = JSON.parse(localStorage.getItem(DB_KEY)) || {
            cash: 0, soldL: 0, soldP: 0, prodL: 0, prodP: 0,
            history: [], inventory: realFlavors
        };

        let cart = [];
        let prodMode = 'fruta';
        let invView = 'fruta';

        function save() {
            localStorage.setItem(DB_KEY, JSON.stringify(db));
            updateUI();
        }

        function go(screenId, btn) {
            document.querySelectorAll('.screen').forEach(s => s.classList.remove('active-screen'));
            document.getElementById('screen-'+screenId).classList.add('active-screen');
            document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
            if(btn) btn.classList.add('active');
            updateUI();
        }

        function setFilter(type, btn) {
            const grid = document.getElementById('flavors-grid');
            const pc = document.getElementById('price-container');
            const fm = document.getElementById('fixed-price-msg');
            grid.innerHTML = '';
            if(type === 'paleta') { pc.style.display='none'; fm.style.display='block'; }
            else { pc.style.display='block'; fm.style.display='none'; }
            
            db.inventory.sort((a,b)=>a.n.localeCompare(b.n)).forEach(item => {
                if(item.t !== type) return;
                const card = document.createElement('div');
                card.className = 'flavor-card';
                card.onclick = () => addToCart(item);
                
                let cs = 'color:#2c2c2c'; 
                let pd = '';
                if(item.t === 'crema') cs = 'color:#AB47BC';
                else if (item.t === 'fruta') cs = 'color:#BA68C8';
                else if(item.t==='paleta') {
                     cs='color:#6A1B9A'; 
                     pd=`<div style="color:#00E676;font-weight:bold;font-size:0.9rem;">$${item.p||10}</div>`;
                }
                
                let stockDisp = item.hidden ? "‚ôæÔ∏è" : item.s;
                card.innerHTML = `<strong style="${cs}">${item.n}</strong><br>${pd}<span class="stock-badge">${stockDisp}</span>`;
                grid.appendChild(card);
            });
            if(btn) { document.querySelectorAll('#screen-pos .filter-btn').forEach(b=>b.classList.remove('active')); btn.classList.add('active'); }
        }

        function addToCart(item) {
            if(item.s <= 0) return alert("Sin stock");
            let price = (item.t==='paleta')?(item.p||10):parseFloat(document.getElementById('price-select').value);
            const ex = cart.find(c=>c.name===item.n && c.price===price);
            if(ex) { if(ex.qty>=item.s) return alert("No hay stock"); ex.qty++; }
            else cart.push({name:item.n, price:price, qty:1, type:item.t, isHidden: item.hidden});
            updateCartUI();
        }

        function updateCartUI() {
            const bar = document.getElementById('cart-bar');
            if(cart.length>0) {
                bar.style.display='flex';
                const t = cart.reduce((a,i)=>a+(i.price*i.qty),0);
                const c = cart.reduce((a,i)=>a+i.qty,0);
                document.getElementById('cart-total').innerText=`$${t}`;
                document.getElementById('cart-count').innerText=c;
            } else bar.style.display='none';
        }

        function showCheckout() {
            const list = document.getElementById('checkout-list');
            list.innerHTML = ''; let t = 0;
            cart.forEach((i, idx) => {
                t += i.price*i.qty;
                const u = i.type==='paleta'?'pz':'L';
                list.innerHTML += `<div class="cart-list-item"><div><strong>${i.name}</strong><br>${i.qty}${u} x $${i.price} = $${i.price*i.qty}</div><button class="delete-btn" onclick="removeFromCart(${idx})">‚úï</button></div>`;
            });
            document.getElementById('checkout-total').innerText = `Total: $${t}`;
            document.getElementById('checkout-modal').style.display='flex';
        }

        function removeFromCart(idx) {
            cart.splice(idx,1); updateCartUI();
            if(cart.length===0) document.getElementById('checkout-modal').style.display='none';
            else showCheckout();
        }

        function finishSale() {
            let tc = 0, tl = 0, tp = 0, det = [];
            cart.forEach(c => {
                const i = db.inventory.find(inv=>inv.n===c.name);
                if(i && !i.hidden) i.s -= c.qty;
                tc += c.price*c.qty;
                if(c.type==='paleta') { tp+=c.qty; det.push(`${c.qty}pz ${c.name}`); }
                else { tl+=c.qty; det.push(`${c.qty}L ${c.name}`); }
            });
            db.cash+=tc; db.soldL+=tl; db.soldP+=tp;
            db.history.unshift({d:new Date().toLocaleTimeString(), a:'VENTA', det:det.join(" + "), m:`+$${tc}`});
            cart=[]; document.getElementById('checkout-modal').style.display='none';
            save(); alert("‚úÖ Venta registrada");
            const ab = document.querySelector('#screen-pos .filter-btn.active');
            if(ab) ab.click();
        }

        function setProdMode(m) {
            prodMode = m;
            ['fruta','crema','paleta'].forEach(mode => {
                document.getElementById(`btn-prod-${mode}`).className = 'filter-btn' + (mode===m?' active':'');
            });
            document.getElementById('prod-subtitle').innerText = m==='paleta'?'Relleno de Paletas':'Producci√≥n de '+m;
            renderProdSelect();
        }

        function renderProdSelect() {
            const s = document.getElementById('prod-flavor');
            s.innerHTML = '';
            db.inventory.sort((a,b)=>a.n.localeCompare(b.n)).forEach(i => {
                if(i.t===prodMode && !i.hidden) s.innerHTML += `<option value="${i.n}">${i.n}</option>`;
            });
        }

        function adjustProd(a) {
            const i = document.getElementById('prod-qty');
            let v = parseInt(i.value)+a; if(v<1) v=1; i.value=v;
        }

        function saveProduction() {
            const n = document.getElementById('prod-flavor').value;
            const q = parseInt(document.getElementById('prod-qty').value);
            const i = db.inventory.find(inv=>inv.n===n);
            if(i) {
                i.s += q;
                if(i.t==='paleta') db.prodP += q; else db.prodL += q;
                const u = i.t==='paleta'?'pz':'L';
                db.history.unshift({d:new Date().toLocaleTimeString(), a:'PROD', det:`${q}${u} ${n}`, m:'-'});
                save(); alert("Guardado");
            }
        }

        function toggleInvView() {
            if(invView==='fruta') invView='crema'; else if(invView==='crema') invView='paleta'; else invView='fruta';
            updateUI();
        }

        function updateUI() {
            document.getElementById('stat-cash').innerText=`$${db.cash}`;
            document.getElementById('stat-sold-l').innerText=`${db.soldL||0} L`;
            document.getElementById('stat-sold-p').innerText=`${db.soldP||0} Pz`;
            document.getElementById('stat-prod-l').innerText=`${db.prodL||0} L`;
            document.getElementById('stat-prod-p').innerText=`${db.prodP||0} Pz`;
            document.getElementById('inv-title').innerText='Inventario de '+invView;
            const tb = document.querySelector('#inv-table tbody');
            tb.innerHTML = '';
            
            db.inventory.sort((a,b)=>a.n.localeCompare(b.n)).forEach(i => {
                if(i.t===invView && !i.hidden) {
                    let rc = i.s<5?'color:red;font-weight:bold;':'';
                    tb.innerHTML += `<tr><td>${i.n}</td><td style="${rc}">${i.s}</td></tr>`;
                }
            });
            document.querySelector('#hist-table tbody').innerHTML = db.history.map(h => 
                `<tr><td>${h.d}</td><td>${h.a}</td><td>${h.det}</td><td style="font-weight:bold;">${h.m}</td></tr>`
            ).join('');
            renderProdSelect(); updateCartUI();
        }

        function closeDay() {
            if(!confirm("¬øCerrar caja? Se reiniciar√° el dinero.")) return;
            db.history.unshift({d:new Date().toLocaleTimeString(), a:'CIERRE', det:'--- CORTE ---', m:'$0'});
            db.cash=0; db.soldL=0; db.soldP=0; db.prodL=0; db.prodP=0; save();
        }

        function clearHistory() {
            if(confirm("¬øEst√°s seguro de BORRAR TODO el historial?\nEsta acci√≥n es permanente.")) {
                if(confirm("‚ö†Ô∏è CONFIRMACI√ìN FINAL\nSe borrar√°n todos los registros de ventas.")) {
                    db.history = [];
                    save();
                    alert("Historial eliminado.");
                }
            }
        }

        function downloadExcel() {
            let csv = "\uFEFFFecha,Accion,Detalle,Monto\n";
            db.history.forEach(h => {
                let cleanDet = h.det.replace(/,/g, ' '); 
                csv += `${h.d},${h.a},"${cleanDet}",${h.m}\n`;
            });
            const blob = new Blob([csv], {type: 'text/csv;charset=utf-8;'});
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url; a.download = `Corte_${new Date().toLocaleDateString().replace(/\//g,'-')}.csv`;
            a.click();
        }

        const firstBtn = document.querySelector('.filter-btn');
        if(firstBtn) setFilter('fruta', firstBtn);
    </script>
</body>
</html>
